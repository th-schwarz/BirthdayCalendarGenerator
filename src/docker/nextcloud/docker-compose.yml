version: "3.8"

services:
  db:
    image: mariadb:11
    container_name: bcg-nextcloud-db
    restart: unless-stopped
    environment:
      - MARIADB_DATABASE=nextcloud
      - MARIADB_USER=nextcloud
      - MARIADB_PASSWORD=nextcloud
      - MARIADB_ROOT_PASSWORD=rootpw
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$MARIADB_ROOT_PASSWORD || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 40s

  nextcloud:
    image: nextcloud:29-apache
    container_name: bcg-nextcloud
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      # Admin user to log in and for DAV access in tests
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=admin123
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost

      # DB connection
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - nextcloud_data:/var/www/html
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/status.php | grep -q 'installed' "]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 60s

  # One-shot init container to install and enable Calendar and Contacts apps
  nextcloud_init:
    image: nextcloud:29-apache
    container_name: bcg-nextcloud-init
    depends_on:
      nextcloud:
        condition: service_healthy
    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud
    volumes:
      - nextcloud_data:/var/www/html
    entrypoint: ["bash", "-lc"]
    command: >
      "
      cd /var/www/html && 
      php occ app:install contacts || true && php occ app:enable contacts &&
      php occ app:install calendar || true && php occ app:enable calendar &&
      echo 'Nextcloud init done.'
      "
    restart: "no"

volumes:
  db_data:
  nextcloud_data:

# Usage:
#   docker compose up -d
#
# Nextcloud UI: http://localhost:8080
#   user: admin
#   pass: admin123
#
# DAV endpoints for tests (admin user):
#   CardDAV: http://localhost:8080/remote.php/dav/addressbooks/users/admin/contacts/
#   CalDAV:  http://localhost:8080/remote.php/dav/calendars/admin/personal/